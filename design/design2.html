<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ä¿®å¤ç‰ˆï¼šåµŒå¥—æ‹–æ‹½ä¸é‡æ’</title>
    <style>
        * { box-sizing: border-box; }
        body { margin: 0; display: flex; height: 100vh; font-family: "Segoe UI", sans-serif; background: #f0f2f5; }

        /* 1. å·¦ä¾§ç‰©æ–™åŒº */
        .sidebar {
            width: 240px; background: #fff; padding: 20px;
            border-right: 1px solid #ddd; display: flex; flex-direction: column; gap: 10px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.05);
            z-index: 10;
        }
        .widget {
            padding: 12px; background: #f9f9f9; border: 1px solid #e0e0e0; border-radius: 4px;
            cursor: grab; display: flex; align-items: center; font-size: 14px; color: #333;
            transition: all 0.2s;
        }
        .widget:hover { border-color: #1890ff; color: #1890ff; background: #e6f7ff; }
        .widget:active { cursor: grabbing; }

        /* 2. ä¸­é—´ç”»å¸ƒ */
        .workspace { flex: 1; padding: 40px; overflow: auto; display: flex; justify-content: center; align-items: flex-start; }
        
        #canvas-root {
            width: 800px; min-height: 800px; background: #fff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); padding: 20px;
            position: relative;
        }

        /* --- ç»„ä»¶é€šç”¨æ ·å¼ --- */
        .comp-node {
            position: relative;
            margin: 5px;
            transition: background 0.2s, border 0.2s;
        }
        
        /* é€‰ä¸­/æ‚¬åœæ€ */
        .comp-node:hover { outline: 1px dashed #1890ff; }
        
        /* æ­£åœ¨è¢«æ‹–æ‹½çš„å…ƒç´ ï¼šå˜ä¸ºåŠé€æ˜ */
        .comp-node.dragging { opacity: 0.4; }

        /* --- å®¹å™¨ç»„ä»¶æ ·å¼ (Container, Row, Column) --- */
        /* å…³é”®ï¼šç»™å®¹å™¨è¶³å¤Ÿçš„å†…è¾¹è·ï¼Œç¡®ä¿é¼ æ ‡èƒ½è½åœ¨å®¹å™¨å†…ï¼Œè€Œä¸æ˜¯è¢«å­å…ƒç´ å æ»¡ */
        .container-node {
            border: 1px dashed #ccc;
            padding: 15px; 
            min-height: 60px; /* ä¿è¯ç©ºå®¹å™¨ä¹Ÿèƒ½è¢«æ‹–å…¥ */
            background: rgba(0,0,0,0.01);
        }
        
        /* æ‹–æ‹½è¿›å…¥å®¹å™¨æ—¶çš„æ¿€æ´»çŠ¶æ€ (HighLight) */
        .container-node.drag-over-active {
            background-color: rgba(24, 144, 255, 0.1);
            border-color: #1890ff;
            border-style: solid;
        }

        /* å¸ƒå±€ç‰¹å®šæ ·å¼ */
        .type-row { display: flex; flex-wrap: wrap; gap: 10px; border-color: #ffadd2; background: #fff0f6; }
        .type-column { flex: 1; min-width: 50px; border-color: #b7eb8f; background: #f6ffed; }
        .type-container { border-color: #d9d9d9; }

        /* --- åŸºç¡€åŸå­ç»„ä»¶æ ·å¼ --- */
        .type-button { display: inline-block; padding: 8px 16px; background: #1890ff; color: white; border-radius: 4px; cursor: move; }
        .type-text { padding: 5px; cursor: move; }

        /* è°ƒè¯•é¢æ¿ */
        .debug-panel { position: fixed; bottom: 10px; right: 10px; background: #333; color: lime; padding: 10px; font-size: 12px; border-radius: 4px; opacity: 0.8; max-height: 200px; overflow: auto; width: 300px; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h4>ğŸ“¦ å¸ƒå±€å®¹å™¨</h4>
        <div class="widget" draggable="true" data-type="container" data-is-container="true">Container (æ™®é€šå®¹å™¨)</div>
        <div class="widget" draggable="true" data-type="row" data-is-container="true">Row (è¡Œ - æ¨ªå‘)</div>
        <div class="widget" draggable="true" data-type="column" data-is-container="true">Column (åˆ— - çºµå‘)</div>
        
        <h4>ğŸ§© åŸºç¡€ç»„ä»¶</h4>
        <div class="widget" draggable="true" data-type="button">Button (æŒ‰é’®)</div>
        <div class="widget" draggable="true" data-type="text">Text (æ–‡æœ¬)</div>
    </div>

    <div class="workspace">
        <!-- æ ¹èŠ‚ç‚¹ä¹Ÿæ˜¯ä¸€ä¸ªå®¹å™¨ -->
        <div id="canvas-root" data-id="root" class="container-node"></div>
    </div>

    <div class="debug-panel" id="debug-info">JSON Tree Preview...</div>

    <script>
        // ==========================================
        // 1. æ•°æ®æ¨¡å‹ (Tree Model)
        // ==========================================
        let treeData = {
            id: 'root',
            type: 'container',
            isContainer: true,
            children: []
        };

        // ==========================================
        // 2. æ‹–æ‹½çŠ¶æ€ç®¡ç†
        // ==========================================
        let dragSource = null;    // 'sidebar' | 'canvas'
        let draggedNodeId = null; // ç”»å¸ƒå†…æ‹–æ‹½æ—¶çš„ Node ID
        let draggedType = null;   // å·¦ä¾§æ‹–æ‹½æ—¶çš„ Type

        // --- å·¦ä¾§ Sidebar æ‹–æ‹½å¼€å§‹ ---
        document.querySelectorAll('.widget').forEach(w => {
            w.addEventListener('dragstart', (e) => {
                dragSource = 'sidebar';
                draggedType = w.dataset.type;
                // ä¼ é€’æ˜¯å¦ä¸ºå®¹å™¨çš„ä¿¡æ¯
                e.dataTransfer.setData('isContainer', w.dataset.isContainer || 'false');
                e.dataTransfer.effectAllowed = 'copy';
            });
        });

        // ==========================================
        // 3. æ¸²æŸ“å¼•æ“ (View)
        // ==========================================
        const canvasRoot = document.getElementById('canvas-root');

        function render() {
            canvasRoot.innerHTML = ''; // æ¸…ç©º
            // æ¸²æŸ“ root çš„ children
            treeData.children.forEach(child => {
                canvasRoot.appendChild(createNodeDOM(child));
            });
            document.getElementById('debug-info').innerText = JSON.stringify(treeData, null, 2);
        }

        // é€’å½’åˆ›å»º DOM
        function createNodeDOM(node) {
            const el = document.createElement('div');
            el.dataset.id = node.id;
            el.classList.add('comp-node');
            el.classList.add(`type-${node.type}`);
            
            // é‡è¦ï¼šæ ‡è®°æ˜¯å¦ä¸ºå®¹å™¨ï¼Œæ–¹ä¾¿åç»­ Drop åˆ¤æ–­
            if (node.isContainer) {
                el.classList.add('container-node');
            }

            // å…è®¸æ‹–æ‹½è‡ªèº«
            el.draggable = true;

            // å†…å®¹æ¸²æŸ“
            if (node.type === 'button') el.innerText = node.content;
            if (node.type === 'text') el.innerText = node.content;

            // é€’å½’æ¸²æŸ“å­èŠ‚ç‚¹
            if (node.children && node.children.length > 0) {
                node.children.forEach(child => {
                    el.appendChild(createNodeDOM(child));
                });
            }

            // --- ç»‘å®šäº‹ä»¶ï¼šç”»å¸ƒå†…ç»„ä»¶å¼€å§‹æ‹–æ‹½ ---
            el.addEventListener('dragstart', (e) => {
                // âš¡ï¸ æ ¸å¿ƒä¿®å¤ï¼šåœæ­¢å†’æ³¡ã€‚
                // å¦‚æœä¸åœæ­¢ï¼Œä½ æ‹– button æ—¶ï¼Œçˆ¶çº§ row ä¹Ÿä¼šè§¦å‘ dragstart
                e.stopPropagation(); 

                dragSource = 'canvas';
                draggedNodeId = node.id;
                
                // è§†è§‰æ•ˆæœï¼šè®©è¢«æ‹–èµ°çš„å…ƒç´ å˜æ·¡
                setTimeout(() => el.classList.add('dragging'), 0);
                e.dataTransfer.effectAllowed = 'move';
            });

            el.addEventListener('dragend', (e) => {
                el.classList.remove('dragging');
                dragSource = null;
                draggedNodeId = null;
                // æ¸…ç†æ‰€æœ‰é«˜äº®
                document.querySelectorAll('.drag-over-active').forEach(el => el.classList.remove('drag-over-active'));
            });

            // --- ç»‘å®šäº‹ä»¶ï¼šä½œä¸º Drop ç›®æ ‡ ---
            if (node.isContainer) {
                bindDropEvents(el);
            }

            return el;
        }

        // ç»™å®¹å™¨ç»‘å®š Drop ç›¸å…³äº‹ä»¶
        function bindDropEvents(el) {
            
            el.addEventListener('dragover', (e) => {
                e.preventDefault(); // å…è®¸ Drop
                
                // âš¡ï¸ æ ¸å¿ƒä¿®å¤ï¼šé˜»æ­¢å†’æ³¡ï¼
                // è¿™ä¿è¯äº†é¼ æ ‡åœ¨ Row ä¸Šæ—¶ï¼ŒRow å“åº”ï¼ŒContainer ä¸å“åº”ã€‚
                e.stopPropagation(); 

                el.classList.add('drag-over-active');
                e.dataTransfer.dropEffect = 'copy';
            });

            el.addEventListener('dragleave', (e) => {
                e.stopPropagation();
                el.classList.remove('drag-over-active');
            });

            el.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation(); // âš¡ï¸ æ ¸å¿ƒä¿®å¤ï¼šDrop ä¹Ÿä¸è¦å†’æ³¡
                
                el.classList.remove('drag-over-active');

                const targetContainerId = el.dataset.id;

                // 1. å¦‚æœæ˜¯ä» Sidebar æ‹–å…¥ (æ–°å¢)
                if (dragSource === 'sidebar') {
                    const newType = draggedType;
                    const isContainer = e.dataTransfer.getData('isContainer') === 'true';
                    
                    const newNode = {
                        id: newType + '_' + Date.now(),
                        type: newType,
                        isContainer: isContainer,
                        content: newType === 'button' ? 'Button' : 'Some text...',
                        children: []
                    };
                    
                    addNode(newNode, targetContainerId);
                } 
                // 2. å¦‚æœæ˜¯ç”»å¸ƒå†…æ‹–åŠ¨ (ç§»åŠ¨)
                else if (dragSource === 'canvas') {
                    // é˜²æ­¢æ‹–å…¥è‡ªå·±å†…éƒ¨
                    if (draggedNodeId === targetContainerId) return;
                    
                    // ç§»åŠ¨é€»è¾‘ï¼šå…ˆåˆ ååŠ 
                    const nodeData = findNode(treeData, draggedNodeId);
                    
                    // æ£€æŸ¥æ­»å¾ªç¯ï¼ˆä¸èƒ½æŠŠçˆ¶çº§æ‹–åˆ°å­çº§é‡Œï¼‰
                    if (checkIsChild(nodeData, targetContainerId)) {
                        alert("æ— æ³•å°†ç»„ä»¶æ‹–å…¥å…¶å­çº§ä¸­ï¼");
                        return;
                    }

                    if (nodeData) {
                        deleteNode(treeData, draggedNodeId);
                        addNode(nodeData, targetContainerId);
                    }
                }
                
                render(); // é‡ç»˜
            });
        }

        // --- åˆå§‹åŒ–æ ¹èŠ‚ç‚¹äº‹ä»¶ ---
        // æ ¹èŠ‚ç‚¹æœ¬èº«ä¹Ÿæ˜¯ä¸ªå®¹å™¨ï¼Œæ‰‹åŠ¨ç»‘å®šä¸€ä¸‹
        bindDropEvents(canvasRoot);


        // ==========================================
        // 4. æ•°æ®æ“ä½œè¾…åŠ©å‡½æ•° (CRUD)
        // ==========================================
        
        // æ·»åŠ èŠ‚ç‚¹åˆ°æŒ‡å®šçˆ¶çº§ ID
        function addNode(node, parentId) {
            if (parentId === 'root') {
                treeData.children.push(node);
                return;
            }
            const parent = findNode(treeData, parentId);
            if (parent && parent.children) {
                parent.children.push(node);
            }
        }

        // æŸ¥æ‰¾èŠ‚ç‚¹
        function findNode(root, id) {
            if (root.id === id) return root;
            if (root.children) {
                for (let child of root.children) {
                    const res = findNode(child, id);
                    if (res) return res;
                }
            }
            return null;
        }

        // åˆ é™¤èŠ‚ç‚¹
        function deleteNode(root, id) {
            if (!root.children) return;
            const idx = root.children.findIndex(n => n.id === id);
            if (idx !== -1) {
                root.children.splice(idx, 1);
                return;
            }
            root.children.forEach(child => deleteNode(child, id));
        }

        // æ£€æŸ¥ targetId æ˜¯å¦æ˜¯ node çš„åä»£
        function checkIsChild(node, targetId) {
            if (!node.children) return false;
            for (let child of node.children) {
                if (child.id === targetId) return true;
                if (checkIsChild(child, targetId)) return true;
            }
            return false;
        }

        // åˆæ¬¡æ¸²æŸ“
        render();

    </script>
</body>
</html>